<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Malware Lab | Network Security Ninja</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Malware Lab" />
<meta name="author" content="Jeremiah Bess" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A blog to post my Tactics, Techniques, and Procedures (TTPs) as a card-carrying member of the Blue Team (Cyber Defense)." />
<meta property="og:description" content="A blog to post my Tactics, Techniques, and Procedures (TTPs) as a card-carrying member of the Blue Team (Cyber Defense)." />
<link rel="canonical" href="http://localhost:4000/malware-lab/" />
<meta property="og:url" content="http://localhost:4000/malware-lab/" />
<meta property="og:site_name" content="Network Security Ninja" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/malware-lab/","headline":"Malware Lab","author":{"@type":"Person","name":"Jeremiah Bess"},"description":"A blog to post my Tactics, Techniques, and Procedures (TTPs) as a card-carrying member of the Blue Team (Cyber Defense).","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Network Security Ninja" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Network Security Ninja</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/malware-lab/">Malware Lab</a><a class="page-link" href="/resources/">Resources</a><a class="page-link" href="/tools/">Tools</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Malware Lab</h1>
  </header>

  <div class="post-content">
    <p>The blog post that goes along with this can be found <a href="/how-to/2019/08/20/building-a-malware-analysis-lab">here</a>.</p>

<h1 id="logical-diagram">Logical diagram</h1>
<p><img src="/assets/malware-lab.png" alt="My Lab" /></p>

<h1 id="host-machine">Host Machine</h1>
<ol>
  <li>Install Virtualbox
    <ol>
      <li><a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></li>
      <li>Open command prompt</li>
      <li><code class="highlighter-rouge">vboxmanage dhcpserver add --netname Lab --ip 10.0.1.1 --netmask 255.255.255.0 --lowerip 10.0.1.2 --upperip 10.0.1.10 --enable</code></li>
    </ol>
  </li>
</ol>

<h1 id="linux-mint-gateway">Linux Mint Gateway</h1>
<p>VM setup:<br />
CPU: 2 cores<br />
RAM: 2 GB<br />
HD: 32 GB<br />
Network: Set up 2 NICs. One set as NAT, the other as Internal (named Lab)</p>

<ol>
  <li>Install Linux Mint and all updates
    <ol>
      <li><a href="https://linuxmint.com/download.php">https://linuxmint.com/download.php</a></li>
      <li>Open command prompt</li>
      <li><code class="highlighter-rouge">sudo apt update &amp;&amp; sudo apt upgrade</code></li>
    </ol>
  </li>
  <li>Virtualbox Guest Additions
    <ol>
      <li>Virtualbox menu &gt; Devices &gt; “Insert Guest Additions CD image”</li>
      <li>Run installer</li>
      <li>Virtualbox menu &gt; Optical Drives &gt; Remove disk from virtual drive</li>
    </ol>
  </li>
  <li>Snapshot
    <ol>
      <li>Linux Mint menu &gt; Quit &gt; Shutdown</li>
      <li>Virtualbox &gt; Snapshot named “Fresh install”</li>
      <li>Start VM again</li>
    </ol>
  </li>
  <li>Install software:
    <ol>
      <li>Wireshark:<code class="highlighter-rouge">sudo apt install wireshark</code>
        <ol>
          <li>Choose yes when asked to allow non-super users capture packets</li>
        </ol>
      </li>
      <li>PIP:<code class="highlighter-rouge">sudo apt install python-pip</code></li>
      <li>Oletools:<code class="highlighter-rouge">sudo -H pip install oletools</code>
        <ul>
          <li>If there are errors try running first:<code class="highlighter-rouge">sudo -H pip install --upgrade setuptools</code></li>
        </ul>
      </li>
      <li>InetSim:<code class="highlighter-rouge">sudo apt install inetsim</code></li>
    </ol>
  </li>
  <li>Polar Proxy
    <ol>
      <li><code class="highlighter-rouge">mkdir ~/PolarProxy</code></li>
      <li><code class="highlighter-rouge">cd ~/PolarProxy/</code></li>
      <li><code class="highlighter-rouge">curl https://www.netresec.com/?Download=PolarProxy | tar -xzvf -</code></li>
      <li><code class="highlighter-rouge">cd ~</code></li>
    </ol>
  </li>
  <li>LabNet setup
    <ol>
      <li>Follow the setup instructions on <a href="https://github.com/netsecninja/LabNet">https://github.com/netsecninja/LabNet</a>
        <ul>
          <li>Note: the labnet.sh file should be in ~ (root of your user profile)</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>Note IP address of Internal NIC: <code class="highlighter-rouge">ip a</code>
    <ol>
      <li>If the IP isn’t 10.0.1.2, just make corrections below to the IP listed.</li>
    </ol>
  </li>
  <li>Snapshot
    <ol>
      <li>Linux Mint menu &gt; Quit &gt; Shutdown</li>
      <li>Virtualbox &gt; Snapshot named “Baseline”</li>
      <li>Start VM again</li>
    </ol>
  </li>
</ol>

<h1 id="windows-10-victim">Windows 10 Victim</h1>
<p>VM setup:<br />
CPU: 2 cores<br />
RAM: 2 GB<br />
HD: 32 GB<br />
Network: Internal (named Lab)</p>

<ol>
  <li>Install Windows 10
    <ol>
      <li><a href="https://www.microsoft.com/en-us/software-download/windows10ISO">https://www.microsoft.com/en-us/software-download/windows10ISO</a></li>
      <li>Download oldest version available (less patches means more vulnerable for testing!)</li>
      <li>Skip network connection (avoids having to log in with a Microsoft account)</li>
    </ol>
  </li>
  <li>Snapshot
    <ol>
      <li>Start menu &gt; Power &gt; Shutdown</li>
      <li>Virtualbox &gt; Snapshot named “Fresh install”</li>
      <li>Start VM again</li>
    </ol>
  </li>
  <li>Disable patches
    <ol>
      <li>Right-click network icon in task tray &gt; Open Network &amp; Internet settings</li>
      <li>Change connection properties</li>
      <li>Enabled Metered connection</li>
    </ol>
  </li>
  <li>Set up Networking
    <ol>
      <li>Right-click network icon in tray, Open Network &amp; Internet Settings</li>
      <li>Change adapter options</li>
      <li>Right-click NIC, Properties</li>
      <li>Double-click on IPv4</li>
      <li>Set DNS to 1.1.1.1 and Linux Mint Internal IP (10.0.1.2)</li>
      <li>Click Advanced</li>
      <li>Add Default Gateway, Linux Mint Internal IP (10.0.1.2)</li>
      <li>Click OK to close all the screens</li>
    </ol>
  </li>
  <li>Set up Polar Proxy cert
    <ol>
      <li>On Linux Gateway: sudo ./labnet.sh polar</li>
      <li>On Victim: Open IE, 10.0.1.2:10080, open .cer file</li>
      <li>Install .cer Certificate in Local Machine’s trusted root certificates folder</li>
    </ol>
  </li>
  <li>Autologin
    <ol>
      <li>Start &gt; Netplwiz</li>
      <li>Click user, uncheck “Users must enter a user name and password to use this computer”</li>
      <li>Apply, enter password</li>
    </ol>
  </li>
  <li>Disable AV
    <ol>
      <li>Open Command Prompt as Admin</li>
      <li><code class="highlighter-rouge">reg.exe ADD "HKLM\Software\Policies\Microsoft\Windows Defender" /t REG_DWORD /v DisableAntiSpyware /d 1</code></li>
    </ol>
  </li>
  <li>Install Guest tools</li>
  <li>Reboot</li>
  <li>Install <a href="https://notepad-plus-plus.org/download/">Notepad++</a></li>
  <li>Install <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon">Sysmon</a>
    <ol>
      <li>Download the <a href="https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml">SwiftOnSecurity policy</a></li>
      <li>Start &gt; CMD &gt; Run as Administrator</li>
      <li>CD into sysmon directory</li>
      <li><code class="highlighter-rouge">sysmon.exe -accepteula -i sysmonconfig-export.xml</code></li>
      <li>Start &gt; Event Viewer</li>
      <li>Right-click Custom View &gt; Create Custom View</li>
      <li>Event Logs &gt; Application and Services Logs &gt; Microsoft &gt; Windows &gt; Sysmon</li>
      <li>Click Ok, name Sysmon</li>
    </ol>
  </li>
  <li>Install <a href="https://www.wireshark.org/#download">Wireshark</a></li>
  <li>Install <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">Procmon</a>
    <ol>
      <li>Options &gt; Disable “Show Resolved Network Addresses”</li>
      <li>Options &gt; Select columns &gt; Add “Thread ID”</li>
    </ol>
  </li>
  <li>Install <a href="http://www.graphviz.org/download/">Graphviz</a></li>
  <li>Install <a href="https://www.winpcap.org/install/default.htm">Winpcap</a></li>
  <li>Download <a href="https://www.winpcap.org/windump/install/default.htm">Windump</a></li>
  <li>Install <a href="http://procdot.com/downloadprocdotbinaries.htm">ProcDOT</a>
    <ol>
      <li>Zip password: procdot</li>
      <li>Set WinDump path</li>
      <li>Set Graphviz dot.exe path (C:\Program Files(x86)\Graphviz#.##\bin\dot.exe)</li>
    </ol>
  </li>
  <li>Install Office or <a href="https://www.libreoffice.org/download/download/">LibreOffice</a></li>
  <li>Install <a href="https://www.python.org/downloads/windows/">Python</a>
    <ol>
      <li>Make sure to check the “Add Python to Path” box during install</li>
      <li>Make sure “pip” is set to installed, which it is by default</li>
    </ol>
  </li>
  <li>Install OLETools
    <ol>
      <li>Command prompt &gt; <code class="highlighter-rouge">pip install oletools</code></li>
    </ol>
  </li>
  <li>Disable sleep under power settings</li>
  <li>Create a Tools folder on Desktop, put shortcuts for:
    <ol>
      <li>Wireshark</li>
      <li>Procmon</li>
      <li>ProcDOT</li>
      <li>Event Viewer</li>
    </ol>
  </li>
  <li>Snapshot
    <ol>
      <li>Start menu &gt; Power &gt; Shutdown</li>
      <li>Virtualbox &gt; Snapshot named “Baseline”</li>
    </ol>
  </li>
</ol>


  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Network Security Ninja</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jeremiah Bess</li><li><a class="u-email" href="mailto:jeremiah.bess@gmail.com">jeremiah.bess@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/netsecninja"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">netsecninja</span></a></li><li><a href="https://www.linkedin.com/in/jeremiahbess"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">jeremiahbess</span></a></li><li><a href="https://www.twitter.com/netsecninja"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">netsecninja</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A blog to post my Tactics, Techniques, and Procedures (TTPs) as a card-carrying member of the Blue Team (Cyber Defense). </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
